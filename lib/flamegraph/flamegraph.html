<!DOCTYPE html>
<html>
<head>
  /**INCLUDES**/

  <meta charset=utf-8 />

  <title>Flame Graph of Page</title>
  <style>
    .graph {
      position: relative;
      border-bottom: 1px solid black;
    }

    [data-blink=true] {
      animation: blink-animation 0.75s steps(5, start) infinite;
      -webkit-animation: blink-animation 0.75s steps(5, start) infinite;
    }
    @keyframes blink-animation {
      to {
        visibility: hidden;
      }
    }
    @-webkit-keyframes blink-animation {
      to {
        visibility: hidden;
      }
    }

    .code {
      font-family: Consolas, Menlo, Monaco, "Lucida Console", "Liberation Mono", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Courier New", monospace;
    }

    .content {
      width: 100%;
    }

    .ui.footer.segment {
      padding: 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      margin-bottom: 0;
      background-color: #f5f5f5;
    }

    #keyboard-modal code {
      border-radius: 3px;
      background-color: rgba(0, 0, 0, 0.06);
      padding: 3px 4px;
    }

    .frame {
      overflow: hidden;
      text-overflow: ellipsis;

    }

    .frame span {
      position: absolute;
      bottom: 0px;
      left: 3px;
    }
  </style>
</head>
<body>
  <script id="info-table-template" type="text/x-handlebars-template">
    <table class="ui compact small table" style="word-break: break-all;">
      <thead>
      <tr>
        <th> ID </td>
        <th> Method </td>
        <th> Gem </td>
        <th> Self </td>
        <th> Samples </td>
        <th> of Parent </td>
        <th> of Zoom </td>
        <th> of Total </td>

        <th> # Calls </td>
        <th> All Samples </td>
        <th> of Total </td>
      </tr>
      </thead>
      <tbody>
      {{#each stats}}
        <tr>
          <td class="one wide"> <i data-id="{{id}}" class="search icon"></i> {{id}} </td>
          <td class="four wide"> <b>{{name}}</b> </td>
          <td class="two wide"> {{gemName}} </td>
          <td > {{selfSamples}} </td>
          <td > {{samples}} </td>
          <td > {{ofParent}}% </td>
          <td > {{ofZoom}}% </td>
          <td > {{ofTotal}}% </td>

          <td > {{calls}} </td>
          <td > {{totalSamples}} </td>
          <td > {{allOfTotal}}% </td>
        </tr>
        <tr>
          <td colspan="11"> <i class="copy icon" data-clipboard-text="{{filePath}}"></i> {{frame}} </td>
        </tr>
      {{/each}}
      </tbody>
    </table>
  </script>

  <div id="main" class="ui fluid container" style="padding: 7px;">
    <div class="graph" oncontextmenu="return false;"></div>

    <div id="keyboard-modal" class="ui modal" >
      <i class="close icon"></i>
      <div class="header">
        Keyboard Commands
      </div>
      <div class="content">
        <h5>Anywhere</h5>
        <p><code>?</code> - show this modal</p>
        <p><code>0</code> - reset zoom</p>
        <p><code>-</code> - zoom out one level</p>
        <p><code>+</code> - previous zoom</p>
        <p><code>g</code> <code>c</code> - color by gem</p>
        <p><code>g</code> <code>m</code> - color by method</p>
        <p><code>f</code> <code>c</code> - clear existing filters</p>
        <p><code>f</code> <code>r</code> - restore previous filters</p>

        <h5>Hover Over Graph Frame</h5>
        <p><code>a</code> - animate frames of same method to blink, toggles on/off</p>
        <p><code>z</code> - zoom to frame</p>
        <p><code>b</code> - backtrace of frame</p>
        <p><code>p</code> - copy file path of frame into clipboard</p>

        <h5>Hover Over Gem or Method Listing</h5>
        <p><code>a</code> - animate the highlighted frames to blink, toggles on/off</p>
        <p><code>z</code> - zoom to frame with most samples in self</p>
        <p><code>b</code> - backtrace of frame with most samples in self</p>
        <p><code>p</code> - copy file path of frame with most samples into clipboard</p>
        <p><code>f</code> <code>i</code> - add/remove from include filter</p>
        <p><code>f</code> <code>e</code> - add/remove from exclude filter</p>
        <br/>
      </div>
    </div>

    <div id="info-modal" class="ui modal" style="height: 95%; width: 95%;">
      <i class="close icon"></i>
      <div class="header">
      </div>
      <div class="content">
      </div>
    </div>

    <div id="backtrace-modal" class="ui modal" style="height: 95%; width: 95%;">
      <i class="close icon"></i>
      <div class="header">
      </div>
      <div class="content">
        <div class="ui top attached tabular menu">
          <a class="active item" data-tab="first">Backtrace</a>
          <a class="item" data-tab="second">Direct Calls</a>
        </div>
        <div class="backtrace ui bottom attached active tab segment" data-tab="first">
        </div>
        <div class="direct-calls ui bottom attached tab segment" data-tab="second">
        </div>
      </div>
    </div>

    <div id="legend" class="ui three column grid" style="margin-top: 5px; ">
      <script id="filter-item-template" type="text/x-handlebars-template">
        <div class="ui label" style="margin-bottom: 1px;">
          {{filter}}
          <i class="delete icon"></i>
        </div>
      </script>
      <div class="four wide column">
        <div class="ui segment">
          <button class="ui button" data-action="help">Help</button>
          <button class="ui disabled right floated button" data-action="resetZoom">No Zoom</button>
          <div class="ui clearing divider hidden"></div>
          <div id="includedFilters" class="">
          </div>
          <form class="ui form">
            <div class="field">
              <input type="text" id="includeFilter" placeHolder="include filter" value="" />
            </div>
            <button class="ui right floated button" data-action="filter" data-type="include">Add</button>
          </form>

          <div class="ui clearing divider hidden"></div>

          <div id="excludedFilters" class="">
          </div>
          <form class="ui form">
            <div class="field">
              <input type="text" id="excludeFilter" placeHolder="exclude filter" value="" />
            </div>
            <button class="ui right floated button" data-action="filter" data-type="exclude">Add</button>
          </form>

          <div class="ui clearing divider hidden"></div>
        </div>
      </div>

      <div class="six wide column">
        <table id="gems-table" class="ui compact small selectable table" style="word-break: break-all;">
          <thead>
            <tr>
              <th class="six wide"> <i data-action="color" data-type="gem" class="paint brush icon"></i> Gem  </td>

              <th class="right aligned" > Self </td>
              <th class="right aligned" > % </td>

              <th class="right aligned" > Total </td>
              <th class="right aligned"> % </td>

              <th class="right aligned"> # Calls </td>
            </tr>
          </thead>
          <tbody>
          </tbody>
          <script id="gem-row-template" type="text/x-handlebars-template">
            <tr style="background-color: {{color}}" >
              <td > {{name}} </td>

              <td class="right aligned" > {{selfSamples}} </td>
              <td class="right aligned"> {{ofSelfTotal}}% </td>

              <td class="right aligned"> {{samplesLength}} </td>
              <td class="right aligned"> {{ofTotal}}% </td>


              <td class="right aligned"> {{frames.length}} </td>
            </tr>
          </script>
        </table>
      </div>

      <div class="six wide column">
        <table id="methods-table" class="ui compact small selectable table" style="word-break: break-all;">
          <thead>
            <tr>
              <th class="six wide"> <i data-action="color" data-type="method" class="paint brush icon"></i>  Method </td>
              <th class="right aligned"> Self </td>
              <th class="right aligned"> % </td>
              <th class="right aligned"> Total </td>
              <th class="right aligned"> % </td>

              <th class="right aligned"> # Calls </td>
            </tr>
          </thead>
          <tbody>
          </tbody>
          <script id="method-row-template" type="text/x-handlebars-template">
            <tr style="background-color: {{color}}" >
              <td>
                <span class="popme">
                  {{name}}
                </span>
              </td>

              <td class="right aligned"> {{selfSamples}} </td>
              <td class="right aligned"> {{ofSelfTotal}}% </td>

              <td class="right aligned"> {{samplesLength}} </td>
              <td class="right aligned"> {{ofTotal}}% </td>

              <td class="right aligned"> {{frames.length}} </td>
            </tr>
          </script>
        </table>
      </div>
    </div>
  </div>
  <div class="ui footer basic segment">
    <div "ui content">
    </div>
  </div>
  <script>

var data = /**DATA**/;

    var maxX = 0;
    var maxY = 0;

    var guessGem = function(frame)
    {
      var split = frame.split('/lib\/ruby/');
      if (split.length > 1 && !frame.includes("/gems/")) {
        split = split[1].split("/")
          if (split.length > 1) {
            split = split[1].split(".")
            return "ruby - " + split[0];
          }
      }

      split = frame.split('/gems/');
      if(split.length == 1) {
        split = frame.split('/app/');
        if(split.length == 1) {
          split = frame.split('/lib/');
        }

        split = split[Math.max(split.length-2,0)].split('/');
        return split[split.length-1].split(':')[0];
      }
      else
      {
        return split[split.length -1].split('/')[0];
      }
    }

    var guessFullMethod = function(frame) {
      var split = frame.split('`');
      if(split.length == 2) {
        var fullMethod = split[1].split("'")[0];
        return fullMethod;
      }
      return '?';
    }

    var guessShortMethod = function(fullMethod) {
      var split = fullMethod.split(".");
      if(split.length > 1) {
        return split[split.length - 1];
      }

      split = fullMethod.split("#");
      if(split.length > 1) {
        return split[split.length - 1];
      }

      return split[0];
    }

    var guessFile = function(frame) {
      var split = frame.split(".rb:");
      if(split.length == 2) {
        split = split[0].split('/');
        return split[split.length - 1];
      }
      return "";
    }

    var guessFilePath = function(frame) {
      var split = frame.split(":in");
      return split[0];
    }

    var storeOriginals = function(data) {
      for(var i=0; i < data.length; i++) {
        var d = data[i];
        d.id = i;
        d.oWidth = d.oWidth || d.width;
        d.oX = d.oX || d.x;
        d.oY = d.oY || d.y;

        if (parsedNames[d.frame]) {
          d.methodName = parsedNames[d.frame].methodName;
          d.shortMethodName = parsedNames[d.frame].shortMethodName;
          d.gemName = parsedNames[d.frame].gemName;
          d.fileName = parsedNames[d.frame].fileName;
        } else {
          parsedNames[d.frame] = {};
          parsedNames[d.frame].methodName = d.methodName = guessFullMethod(d.frame);
          parsedNames[d.frame].shortMethodName = d.shortMethodName = guessShortMethod(d.methodName);
          parsedNames[d.frame].gemName = d.gemName = guessGem(d.frame);
          parsedNames[d.frame].fileName = d.fileName = guessFile(d.frame);
        }

        d.opacityFactor = 1;
        setSamples(d);
      }
    }

    var setSamples = function(d) {
      d.samples = {};
      for(var j=0; j < d.oWidth; j++){
        d.samples[d.oX + j] = 1;
      }
      d.samplesLength = j;
    }

    $.each(data, function(){
       maxX = Math.max(maxX, this.x + this.width);
       maxY = Math.max(maxY, this.y);
    });

    oMaxX = maxX;
    oMaxY = maxY;

    var width = $("#main").width();
    var height = ($(window).height() / 1.35);
    $('.graph').width(width).height(height);
    $('#legend').height($(window).height() - height).css({overflow: "scroll"});

    var xScale = d3.scale.linear()
      .domain([0, maxX])
        .range([0, width]);

    var yScale = d3.scale.linear()
        .domain([0, maxY])
        .range([0,height]);

    var graph = d3.select(".graph")
                        .attr("width", "100%")
                        .attr("height", "100%");

    var color = function() {
      var r = parseInt(205 + Math.random() * 50);
      var g = parseInt(Math.random() * 230);
      var b = parseInt(Math.random() * 55);
      return "rgb(" + r + "," + g + "," + b + ")";
    }
    var info = {
      gem: {},
      method: {}
    };

    var parsedNames = {}

    var templates = {};
    var template = function(name) {
      templates[name] = templates[name] || Handlebars.compile($("#" + name).html());
      return templates[name];
    };

    var frameStats = function(d) {
      var i = info[byType][d.frame];

      inSet = dataStats["method"][d.methodName];

      var childrenSize = 0;
      $.each(d.filteredChildren || [], function() {
        childrenSize = childrenSize + this.samplesLength;
      });

      d.filePath = d.filePath || guessFilePath(d.frame);

      var stat = {
        id: d.id,
        name: d.methodName,
        shortName: d.shortMethodName,
        gemName: d.gemName,
        filePath: d.filePath,
        frame: d.frame,
        samples: d.samplesLength,
        selfSamples: d.samplesLength - childrenSize,
        ofZoom: inSet ? "no zoom" : "beyond zoom",
        ofParent: "No Parent ",
        ofTotal: ((d.samplesLength / oMaxX) * 100).toFixed(2),
        totalSamples: i.samplesLength,
        allOfTotal: ((i.samplesLength / oMaxX) * 100).toFixed(2),
        calls: inSet ? dataStats["method"][d.methodName].count : "beyond zoom"
      };

      if (d.filteredParent) {
        stat['ofParent'] = ((d.samplesLength / d.filteredParent.samplesLength) * 100).toFixed(2);
      }

      if (inSet && currentZoom) {
        stat["ofZoom"] = ((d.samplesLength / currentZoom.samplesLength) * 100).toFixed(2);
      }

      return stat;
    }

    var copyToClipboard = function(text) {
      var clip = new Clipboard("lala", {
        text: function() { return text; },
        action: function() { return "copy"; },
        target: function() { return undefined; }
      });
      clip.onClick({});
    }

    var mouseover = function(d) {
      keyboardJS.setContext("frame");
      currentFrame = d;

      var stat = frameStats(d);

      $('.ui.footer').html(template("info-table-template")({stats: [stat]})).show();
      d3.selectAll("div.frame[method='" + d.methodName + "']")
        .style('background-color', "black")
        .style('color', "white")
        .style('opacity', 0.5);
    };

    var mouseout = function(d) {
      keyboardJS.setContext("");
      currentFrame = null;

      var i = info[byType][d.frame];
      $('.ui.footer').hide().children().remove();
      d3.selectAll("div.frame[method='" + d.methodName + "']")
        .style('background-color', function(d) { return d.fill; })
        .style('color', function(d) { return d.textColor; })
        .style('opacity', function(f) { return f.opacityFactor });
    };

    var selectElement = function(e) {
      keyboardJS.setContext(e.data.type);
      var name = e.data.name;
      currentElement = name;
      d3.selectAll("div.frame[" + e.data.type +"='" + name + "']")
        .style('background-color', "black")
        .style('color', "white")
        .style('opacity', 0.5);
      return false;
    };

    var deselectElement = function(e) {
      keyboardJS.setContext('');
      currentElement = null;
      var name = e.data.name;
      d3.selectAll("div.frame[" + e.data.type + "='" + name + "']")
        .attr('data-blink', "")
        .style('background-color', function(d) { return d.fill; })
        .style('color', function(d) { return d.textColor; })
        .style('opacity', function(d) { return d.opacityFactor });
      return false;
    };

    var backtrace = function(frame){
      frames = [frame];

      var parent = filteredParent(frame)
      while (parent) {
        frames.push(parent);
        parent = filteredParent(parent)
      }

      return frames;
    }

    var zoomedDataFilter = function(d) {
      if (!currentZoom) {
        return true
      }

      return d.zoomed;
    }

    var anyActiveFilters = function() {
      return includedFilters.length > 0 || excludedFilters.length > 0;
    };

    var filteredDataFilter = function(d) {
      if (!anyActiveFilters()) {
        return true;
      }

      return d.filteredIn;
    }

    var resetElement = function(e) {
      if (!e.filteredOut) {
        if (!e.filteredIn) {
          e.y = e.oY;
        }
        e.x = e.oX;
        e.width = e.oWidth;
        e.opacityFactor = 1;
        e.zoomed = null;
      }
    }

    var resetData = function() {
      for(var i = 0; i < data.length; i++) {
        var d = data[i];

        resetElement(d);
      }
    }

    var resetZoom = function() {
      zoom(null);
    }

    var zoom = function(d, options) {
      if (currentZoom) {
        lastZoom = currentZoom;
      }

      currentZoom = d;

      resetData();

      if (currentZoom) {
        $.each([d].concat(d.allChildren), function() { 
          this.zoomed = true; 
          this.x = this.x - d.oX + 1;
        });
        $("[data-action=resetZoom]").removeClass("disabled").text("Reset Zoom");
      } else {
        $("[data-action=resetZoom]").addClass("disabled").text("No Zoom");
      }

      processData(data);
      drawData(data, options);

      return false;
    }

    var showInfo = function(e){
      var name = e.data.name;
      var type = e.data.type;

      var set = dataStats[type][name];

      $modal = $("#info-modal");
      $modal.find(".header").text(type + " " + name + " Info");

      var stats = set.data.map(frameStats);
      stats = stats.sort(function(a, b) { return b.selfSamples - a.selfSamples; });

      $modal.find('.content').html(template("info-table-template")({stats: stats}));

      $modal.find(".search.icon").on("click", function() {
        var id = parseInt($(this).data("id"), 10);
        zoom(data[id]);
        $modal.modal('hide');
        return false;
      });

      $modal.modal('show');

      return false;
    };

    var showBacktrace = function(d){
      var trace = backtrace(d);

      $modal = $("#backtrace-modal");

      $modal.find(".header").text("Backtrace Info");
      var stats = trace.map(frameStats)
      $modal.find('.backtrace').html(template("info-table-template")({stats: stats}));


      stats = d.filteredChildren.map(frameStats);
      $modal.find('.direct-calls').html(template("info-table-template")({stats: stats}));

      $modal.find(".search.icon").on("click", function() {
        var id = parseInt($(this).data("id"), 10);
        zoom(data[id]);
        $modal.modal('hide');
        return false;
      });

      $modal.modal('show');

      return false;
    };

    var byType = "method";

    var dataStats = {
      gem: {},
      method: {},
    };

    var dataSorted = {
      gem: {},
      method: {},
    };

    var colors = {
      gem: {},
      method: {}
    };

    function analyzeData(data, type) {
      type = type || byType;

      dataStats[type] = {}
      dataSorted[type] = {}

      // assign some colors, analyze samples per type
      $.each(data, function(){
        var group = this[type + "Name"];
        var stat = dataStats[type][group];

        if(!stat) {
          dataStats[type][group] = stat = {count: 0, name: group, samplesLength: 0, samples: {}, frames: [], data: []};
        }


        stat.count = stat.count + 1;
        stat.frames.push(this.frame);
        stat.data.push(this);
        for(var j=0; j < this.width; j++){
          stat.samples[this.x + j] = 1;
        }
      });

      var totalGroupData = 0;
      $.each(dataStats[type], function(k,stat){
        totalGroupData++;
        stat.samplesLength = Object.keys(stat.samples).length;
      });


      dataSorted[type] = _(dataStats[type]).pairs()
                                .sortBy(function(item){
                                    return -item[1].samplesLength;
                                  })
                                .map(function(item){return item[1]})
                                .value();

      var currentIndex = 0;
      var rColors = randomColor({count: totalGroupData});
      var colorStats = function(stat){

        stat.color = colors[type][stat.name] = colors[type][stat.name] || rColors[currentIndex];

        for(var x=0; x < stat.frames.length; x++) {
          info[type][stat.frames[x]] = info[type][stat.frames[x]] || {samplesLength: 0, samples: {}, color: stat.color};
        }

        currentIndex += 1;
      };

      _.each(dataSorted[type], colorStats);
    }

    var directFilteredChildren = function(d) {
      if (!anyActiveFilters()) {
        return d.children;
      }

      return filteredChildren(d).filter(function(c) { return c.y == d.y + 1 });
    };

    var filteredChildren = function(d) {
      return d.allChildren.filter(filteredDataFilter);
    };

    var filteredParent = function(d) {
      return d.allParents.filter(filteredDataFilter)[0];
    };

    var visibleParent = function(d) {
      return d.allParents.filter(filteredDataFilter).filter(zoomedDataFilter)[0];
    };

    var setRelations = function(data) {
      var length = data.length;
      for(var i=0; i < data.length; i++) {
        var d = data[i];
        var depth = d.oY;

        d.parent = null;
        d.children = [];
        d.allParents = [];

        if (d.oY == 1) {
          continue;
        }

        while(depth >= 0) {
          var x = i;
          while(x >= 0){
            data[x].children = data[x].children || [];

            if (
                data[x].oY === depth - 1  
               // && 
             //   data[x].oX <= d.oX && 
              //   data[x].oX + data[x].oWidth >= d.oX + d.oWidth
               ) {
              d.parent = data[x];
              var parent = d.parent;
              while (parent) {
                d.allParents.push(parent);
                parent.allChildren = parent.allChildren || [];
                parent.allChildren.push(d);
                parent = parent.parent;
              }
              data[x].children.push(d);
              break;
            }

            x--;
          }

          var dEndPoint = d.oX + d.oWidth;
          var parentEndPoint = d.parent.oX + d.parent.oWidth;
          if (parentEndPoint < dEndPoint) {
            var new_element = jQuery.extend({}, d);
            new_element.children = [];
            new_element.parent = null;
            new_element.samples = null;
            
            var oldWidth = d.oWidth;
            d.oWidth = d.width = parentEndPoint - d.oX;
            new_element.oWidth = new_element.width = oldWidth - d.oWidth;
            
            new_element.oX = new_element.x = parentEndPoint;
            
            setSamples(d);
            setSamples(new_element);
            
            var z = i;
            while(z < data.length - 1) {
              if (data[z].oY == d.oY - 1) {
                break;
              }
            
              z++;
            }
            
            new_element.id = z + 1;
            
            data.splice(z + 1, 0, new_element);
            length = data.length;
          }

          if (d.parent) {
            break;
          }

          // for debugging bad nodes
          d.odd_parent = true;

          depth--;
        }
      }

      for(var i=0; i < data.length; i++) {
        var d = data[i];
        d.id = i;
      }
    }

    var hexToRgb = function(hex) {
      var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    function setMaxX(data, zoomedAndFiltered) {
      maxX = d3.max(zoomedAndFiltered, function(d) { return d.x + d.width});

      xScale = d3.scale.linear()
        .domain([0, maxX])
        .range([0, width]);

      return maxX;
    }

    function setMaxY(data, zoomedAndFiltered) {
      maxY = -1;
      minY = Infinity;

      var filteredData = zoomedAndFiltered.filter(function(d) { return xScale(d.width) > displayWidth });

      maxY = d3.max(filteredData, function(d) { return d.y; });
      minY = d3.min(filteredData, function(d) { return d.y; });

      yScale = d3.scale.linear()
        .domain([0, maxY - minY + 1])
        .range([0,height]);

      return maxY;
    }

    function processFrameInfo(data, type) {
      for(var i=0; i < data.length; i++) {
        var d = data[i];

        var info_frame = info[type][d.frame];
        for(var j=0; j < d.width; j++){
          info_frame.samples[d.x + j] = 1;
        }
        info_frame.samplesLength = info_frame.samplesLength + j;
      }
    }

    function processData(data) {
      zoomedAndFiltered = zoomedAndFilteredData(data);

      setMaxX(data, zoomedAndFiltered);
      setMaxY(data, zoomedAndFiltered);

      for(var i=0; i < data.length; i++) {
        var d = data[i];

        d.scaledX = xScale(d.x-1);
        d.scaledY = yScale(maxY - d.y);
        d.displayW = d.scaledW = xScale(d.width);
        d.scaledH = yScale(1);

        var info_frame = info[byType][d.frame];
        d.fill = info_frame.color;

        // from: http://stackoverflow.com/questions/11867545/change-text-color-based-on-brightness-of-the-covered-background-area
        var rgb = hexToRgb(d.fill);
        var o = Math.round(((rgb.r * 299) +
              (rgb.b * 587) +
              (rgb.g * 114)) / 1000);
        d.textColor = (o > 145) ? 'black' : 'lightyellow';

      }
    }

    function resetFilter() {
      for(var i = 0; i < data.length; i++) {
        var d = data[i];
        d.filteredIn = null;
        d.filteredOut = null;
        d.filteredChildren = null;
        d.filteredParent = d.parent;
      }
    };

    function filterDataByFrame(includedFilters, excludedFilters) {
      resetFilter();

      if (includedFilters.length > 0 || excludedFilters.length > 0) {
        for(var i=0; i < data.length; i++) {
          var d = data[i];

          var shouldInclude = false;
          var shouldExclude = true;

          if (includedFilters.length > 0) {
            shouldInclude = includedFilters.some(function(v) { return d.frame.indexOf(v) >= 0; })
          } else {
            shouldInclude = true;
          }

          if (excludedFilters.length > 0) {
            shouldExclude = excludedFilters.some(function(v) { return d.frame.indexOf(v) >= 0; });
          } else {
            shouldExclude = false;
          }

          if (shouldInclude && !shouldExclude) {
            d.y = d.oY;
            d.filteredIn = true;
            d.filteredParent = filteredParent(d);
            d.filteredChildren = d.filteredChildren || [];
            if (d.filteredParent) {
              d.filteredParent.filteredChildren.push(d);
              d.y = d.filteredParent.y + 1;
            }
          } else {
            d.filteredOut = true;
            d.y = -1;
          }
        }
      }

    }

    function remove_odd_nodes() {
      var remove = data.filter(function(d) {
        return d.oY > 1 && !d.parent;
      });

      $.each(remove, function() {
        remove_node_and_children(this);
      });
    }

    function remove_node_and_children(node) {
      var i = data.indexOf(node);
      data.splice(i, 1);

      $.each(node.children, function() {
        remove_node_and_children(this);
      });
    }

    var zoomedAndFilteredData = function(data) {
      return data.filter(zoomedDataFilter).filter(filteredDataFilter);
    }

    function drawData(data, options) {
      options = options || {};

      var display_width_filter = function(d) {
        return d.displayW > displayWidth;
      }

      var filteredData = zoomedAndFilteredData(data);

      if (!options.enter) {
        analyzeData(filteredData, "method");
        analyzeData(filteredData, "gem");
      }

      filteredData = filteredData.filter(display_width_filter);

      var rects = graph.selectAll("div")
        .data(filteredData);

        rects.enter()
          .append("div")
          .attr("class", "frame")
          .on("contextmenu", showBacktrace)
          .on("click", zoom)
          .on("mouseover", mouseover)
          .on("mouseout", mouseout);

      rects.exit().style("display", "none");

      var stroke = 0.05;
      if (maxY - minY > 250) {
        stroke = 0;
      }

      fontSize = filteredData[0].scaledH * 0.5;
      if (fontSize > 12) {
        fontSize = 12;
      }

      rects
        .each(function(d) { d.node = this; } )
        .attr("frameId", function(d) { return d.id } )
        .attr("gem", function(d) { return d.gemName } )
        .attr("method", function(d) { return d.methodName } )
        .style("display", "block")
        .style("position", "absolute")
        .style("right",function(d) { return d.scaledX + "px"; })
        .style("top",function(d) { return d.scaledY + "px"; })
        .style("width", function(d){ return d.displayW + "px"; })
        .style("height", function(d){ return d.scaledH + "px"; })
        .style("background-color", function(d){ return d.fill; })
        .style("color", function(d){ return d.textColor; })
        .style("opacity", function(d){ return d.opacityFactor; })
        .style("font-size", fontSize + "px")
        .style("cursor", "pointer")
        .style("border-top", stroke + "px solid black")
        .style("border-right", stroke + "px solid black")
        .style("border-left", stroke + "px solid black")
        .html(function(d) { return $("<span>").text(d.shortMethodName).get(0).outerHTML; });

      if (fontSize > 7) {
        $.each(filteredData, function() {
          var node = this.node;

          if (node.scrollWidth > node.offsetWidth && this.displayW < 40) {
            $(node).find("span").hide();
          }
        });
      } else {
        $("div.frame span").hide();
      }

      setTimeout(function() {
        renderLegend("gem");
        renderLegend("method");
      }, 10);
    }



    function renderLegend(type) {
      // render the legend
      var maxPoint = oMaxX;

      if (currentZoom) {
        maxPoint = currentZoom.samplesLength;
      }

      $.each(dataSorted[type], function() {
        this.ofTotal = ((this.samplesLength / maxPoint) * 100).toFixed(2);
        this.shortName = guessShortMethod(this.name);
        var sampleSize = 0;
        var childrenSize = 0;
        $.each(this.data || [], function() {
          var d = this;
          sampleSize = sampleSize + this.samplesLength;
          d.filteredChildren = d.filteredChildren || directFilteredChildren(d);
          $.each(d.filteredChildren, function() {
            childrenSize = childrenSize + this.samplesLength;
          });
        });
        this.selfSamples = sampleSize - childrenSize;
        this.ofSelfTotal = ((this.selfSamples / maxPoint) * 100).toFixed(2);
        this.ofTotal = ((this.samplesLength / maxPoint) * 100).toFixed(2);
      });

      var dataDisplay = dataSorted[type].filter(function(s) {
        return s.ofSelfTotal > 0.1;
      });
      dataDisplay = dataDisplay.sort(function(a, b) { return b.selfSamples - a.selfSamples; });

      $("#" + type + "s-table tbody").children().remove();
      _.each(dataDisplay, function(display) {
        var html = $($.trim(template(type + "-row-template")(display)))
          .on("mouseover", {name: display.name, type: type}, selectElement)
          .on("mouseout", {name: display.name, type: type}, deselectElement)
          .on("click", {name: display.name, type: type}, showInfo);

        $("#" + type + "s-table tbody").append(html);
      });
    }

    function displayFilters(options) {
      options = options || {};
      var forType = function(type) {
        var values = window[type + "Filters"];
        var $container = $("#" + type + "Filters");
        $container.children().remove();
        $.each(values, function() {
          var html = $($.trim(template("filter-item-template")({filter: this})));

          html.find(".delete").on("click", {type: type, filter: this}, function(e) {
            var index = window[e.data.type + "Filters"].indexOf(e.data.filter.toString());
            window[e.data.type + "Filters"].splice(index, 1);
            displayFilters();

            return false;
          });

          $container.append(html);
        });
      };

      forType("included");
      forType("excluded");

      filterDataByFrame(includedFilters, excludedFilters);

      zoom(currentZoom, options);
    };

    function smallThanChildren() {
      return data.filter(function(d) {
        var sampleSize = d.oWidth;
        var childrenSize = 0;
        $.each(d.children || [], function() {
          childrenSize = childrenSize + this.oWidth;
        });
        d.childrenSize = childrenSize;
        return childrenSize > sampleSize;
      });
    }

    var displayWidth = 1;
    var includedFilters = /**JS_INCLUDE_FILTERS**/;
    var excludedFilters = /**JS_EXCLUDE_FILTERS**/;
    var currentZoom = null;
    var lastZoom = null;

    storeOriginals(data);
    setRelations(data);

    analyzeData(data, "method");
    processFrameInfo(data, "method");

    analyzeData(data, "gem");
    processFrameInfo(data, "gem");

    displayFilters({enter: true});

    var colorFrames = function(type) {
      byType = type;
      processData(data);
      drawData(data);

      $("[data-action=color]").css({color: "black"});
      $("[data-type=" + byType + "][data-action=color]").css({color: "red"});
    };

    $("[data-action=color]").on("click", function() {
      colorFrames($(this).data("type"));
    });

    colorFrames(byType);

    $("button[data-action=resetZoom]").on("click", function() {
      resetZoom();
      return false;
    });

    $("button[data-action=help]").on("click", function() {
      $("#keyboard-modal").modal('show');
      return false;
    });

    $("button[data-action=filter]").on("click", function() {
      var type = $(this).data("type");

      var $text = $("#" + type + "Filter");
      var value = $.trim($text.val());

      if (value == "") {
        return false;
      }

      window[type + "dFilters"].push(value);
      $text.val("");

      displayFilters();

      return false;
    });

    $("#backtrace-modal a.item").tab();

    // keyboard settings

    var commands = [];
    var inField = false;
    var currentFrame = null;
    var currentElement = null;

    keyboardJS.bind('?', function(e) {
      $("#keyboard-modal").modal('show');
    });

    // start a filtering context
    keyboardJS.bind('f', function(e) {
      if (inField) return;
      keyboardJS.setContext("filter");
    });

    // start a gem context
    keyboardJS.bind('g', function(e) {
      if (inField) return;

      keyboardJS.setContext("gem");
    });

    // start a method context
    keyboardJS.bind('m', function(e) {
      if (inField) return;

      keyboardJS.setContext("method");
    });

    // reset zoom
    keyboardJS.bind('0', function(e) {
      if (inField) return;

      resetZoom();
    });

    // zoom out
    keyboardJS.bind('-', function(e) {
      if (inField) return;

      if (currentZoom) {
        if (currentZoom.filteredParent) {
          zoom(currentZoom.filteredParent);
        }
      }
    });

    // go to last zoom
    keyboardJS.bind('=', function(e) {
      if (inField) return;

      if (lastZoom) {
        zoom(lastZoom);
      }
    });

    _.each(["gem", "method"], function(type) {
      keyboardJS.withContext(type, function() {
        keyboardJS.bind('c', function(e) {
          colorFrames(type);
        });

        var findTopElement = function(name) {
          var set = dataStats[type][currentElement];
          var stats = set.data.map(frameStats);
          stats = stats.sort(function(a, b) { return b.selfSamples - a.selfSamples; });
          return stats[0];
        };

        keyboardJS.bind('z', function(e) {
          if (!currentElement) return;

          zoom(data[findTopElement(currentElement).id]);
        });

        keyboardJS.bind('b', function(e) {
          if (!currentElement) return;

          showBacktrace(data[findTopElement(currentElement).id]);
        });

        keyboardJS.bind('p', function(e) {
          if (!currentElement) return;

          copyToClipboard(findTopElement(currentElement).filePath);
        });

        keyboardJS.bind('a', function(e) {
          if (!currentElement) return;

          var blink = "true";
          var matcher = "div.frame[" + type + "='" + currentElement + "']";

          if ($(matcher + "[data-blink=true]").length) {
            blink = "";
          }

          d3.selectAll(matcher).attr('data-blink', blink);
        });
      });
    });

    keyboardJS.withContext('filter', function() {
      keyboardJS.bind('c', function(e) {
        previousIncludedFilters = includedFilters;
        previousExcludedFilters = excludedFilters;
        includedFilters = [];
        excludedFilters = [];

        displayFilters();

        keyboardJS.setContext("");
      });

      keyboardJS.bind('r', function(e) {
        includedFilters = previousIncludedFilters;
        excludedFilters = previousExcludedFilters;

        displayFilters();

        keyboardJS.setContext("");
      });

      keyboardJS.bind('i', function(e) {
        if (!currentElement) return;

        if(_.contains(includedFilters, currentElement)) {
          includedFilters = _.without(includedFilters, currentElement);
        } else {
          includedFilters.push(currentElement);
        }

        displayFilters();

      });

      keyboardJS.bind('e', function(e) {
        if (!currentElement) return;

        if(_.contains(excludedFilters, currentElement)) {
          excludedFilters = _.without(excludedFilters, currentElement);
        } else {
          excludedFilters.push(currentElement);
        }

        displayFilters();

      });
    });

    keyboardJS.withContext('frame', function() {
      keyboardJS.bind("z", function(e) {
        zoom(currentFrame);
        keyboardJS.setContext("");

      });

      keyboardJS.bind("a", function(e) {
        if (!currentFrame) return;
        var blink = "true";
        var matcher = "div.frame[method='" + currentFrame.methodName + "']";

        if ($(matcher + "[data-blink=true]").length) {
          blink = "";
        }

        d3.selectAll(matcher).attr('data-blink', blink);
      });

      keyboardJS.bind("b", function(e) {
        showBacktrace(currentFrame);
        keyboardJS.setContext("");
      });

      keyboardJS.bind("p", function(e) {
        copyToClipboard(currentFrame.filePath)
        keyboardJS.setContext("");
      });
    });


    $("input").focus(function() {
      inField = true;
    }).blur(function() {
      inField = false;
    });

    new Clipboard('.icon.copy');

  </script>
</body>
</html>
